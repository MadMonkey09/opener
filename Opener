(function () {
    'use strict';

    let resultMap = {};
    let isOpening = false;

    const font = `'Roboto Mono', monospace`;
    const fontLink = document.createElement('link');
    fontLink.href = 'https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap';
    fontLink.rel = 'stylesheet';
    document.head.appendChild(fontLink);

    const resultPanel = document.createElement('section');
    resultPanel.id = 'blookTally';
    Object.assign(resultPanel.style, {
        display: 'none', position: 'fixed', top: '90px', right: '40px', width: '320px',
        maxHeight: '420px', backgroundColor: '#1e1e2f', color: '#d8d8f2', padding: '15px',
        border: '2px solid #7c56ff', borderRadius: '16px', boxShadow: '0 8px 24px rgba(124, 86, 255, 0.4)',
        zIndex: 2100, overflowY: 'auto', transition: 'right 0.35s ease', fontFamily: font,
        fontSize: '1em', userSelect: 'none', scrollbarWidth: 'thin', scrollbarColor: '#7c56ff transparent'
    });
    document.body.appendChild(resultPanel);

    const style = document.createElement('style');
    style.textContent = `
        #blookTally::-webkit-scrollbar { width: 8px; }
        #blookTally::-webkit-scrollbar-track { background: transparent; }
        #blookTally::-webkit-scrollbar-thumb { background-color: #7c56ff; border-radius: 8px; }
    `;
    document.head.appendChild(style);

    function appendBlook(name) {
        const info = blacket.blooks[name] || {};
        const img = info.image || '/content/blooks/Error.webp';
        const rarity = info.rarity || 'Unknown';
        const color = blacket.rarities[rarity]?.color || '#7c56ff';

        if (!resultMap[name]) {
            const item = document.createElement('div');
            item.style = `display:flex;align-items:center;margin:8px 0;border-left:5px solid ${color};padding:10px 12px;background-color:#2a2a45;border-radius:10px;box-shadow:0 2px 8px rgba(124,86,255,0.15);`;
            item.innerHTML = `<img src="${img}" alt="${name}" style="width:30px;height:30px;margin-right:12px;border-radius:6px;box-shadow:0 0 5px ${color};"><span style="color:${color};font-weight:700;font-size:1.05em;">${name} (<span class="blook-count">1</span>)</span>`;
            resultMap[name] = { count: 1, element: item };
            resultPanel.appendChild(item);
        } else {
            resultMap[name].count++;
            const span = resultMap[name].element.querySelector('.blook-count');
            span.textContent = resultMap[name].count;
            span.style.transition = 'transform 0.15s ease';
            span.style.transform = 'scale(1.3)';
            setTimeout(() => span.style.transform = 'scale(1)', 150);
        }
        resultPanel.scrollTop = resultPanel.scrollHeight;
    }

    function showSummary(total) {
        const summary = document.createElement('div');
        summary.style = 'margin-top:15px;font-weight:700;font-size:1.25em;text-align:center;color:#bb86fc;';
        summary.textContent = `Total Packs Opened: ${total}`;
        resultPanel.appendChild(summary);

        const repeatBtn = document.createElement('button');
        repeatBtn.textContent = 'Open More Packs';
        Object.assign(repeatBtn.style, {
            marginTop: '18px', width: '100%', padding: '12px 0', fontSize: '1em', fontWeight: '700',
            color: '#fff', backgroundColor: '#7c56ff', border: 'none', borderRadius: '12px', cursor: 'pointer',
            boxShadow: '0 4px 16px rgba(124,86,255,0.5)', fontFamily: font,
        });
        repeatBtn.onmouseenter = () => repeatBtn.style.backgroundColor = '#936dff';
        repeatBtn.onmouseleave = () => repeatBtn.style.backgroundColor = '#7c56ff';
        repeatBtn.onclick = () => {
            modal.style.display = 'block';
            resultPanel.style.right = '40px';
            resultPanel.innerHTML = '';
            resultMap = {};
        };
        resultPanel.appendChild(repeatBtn);
    }

    async function openPack(pack) {
        return new Promise(resolve => {
            blacket.requests.post('/worker3/open', { pack }, data => {
                if (data.error) return resolve(null);
                blacket.user.tokens -= blacket.packs[pack].price;
                blacket.user.blooks[data.blook] = (blacket.user.blooks[data.blook] || 0) + 1;
                resolve(data.blook);
            });
        });
    }

    async function openPacksSequential(pack, count) {
        isOpening = true;
        resultMap = {};
        resultPanel.innerHTML = '';
        resultPanel.style.display = 'block';

        let opened = 0;
        while (opened < count && isOpening) {
            const blook = await openPack(pack);
            if (!blook) {
                await new Promise(r => setTimeout(r, 50));
                continue;
            }
            appendBlook(blook);
            opened++;
            const rarity = blacket.blooks[blook]?.rarity || 'Unknown';
            const wait = Math.max(7, blacket.rarities[rarity]?.wait || 50);
            await new Promise(r => setTimeout(r, wait));
        }

        showSummary(opened);
        resultPanel.style.right = '40px';
        isOpening = false;
    }

    const modal = document.createElement('div');
    Object.assign(modal.style, {
        position: 'fixed', top: '18%', left: '50%', transform: 'translateX(-50%)', backgroundColor: '#2a2a45',
        padding: '30px 40px', borderRadius: '18px', boxShadow: '0 12px 36px rgba(124,86,255,0.7)',
        zIndex: 3100, color: '#e0d9ff', fontFamily: font, display: 'none', textAlign: 'center', width: '350px'
    });

    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'âœ•';
    Object.assign(closeBtn.style, {
        position: 'absolute', top: '12px', right: '16px', background: 'transparent', border: 'none', fontSize: '1.5rem', color: '#ccc', cursor: 'pointer'
    });
    closeBtn.onmouseenter = () => closeBtn.style.color = '#ff6b81';
    closeBtn.onmouseleave = () => closeBtn.style.color = '#ccc';
    closeBtn.onclick = () => modal.style.display = 'none';
    modal.appendChild(closeBtn);

    const form = document.createElement('div');
    form.style = 'display:flex;flex-direction:column;gap:18px;align-items:center;';

    const packLabel = document.createElement('label');
    packLabel.textContent = 'Select Pack:';
    form.appendChild(packLabel);

    const packSelect = document.createElement('select');
    Object.assign(packSelect.style, {
        padding: '12px 15px', borderRadius: '12px', backgroundColor: '#1b1b2f',
        color: '#e0d9ff', border: '1px solid #7c56ff', width: '100%', cursor: 'pointer'
    });
    Object.keys(blacket.packs).forEach(p => {
        const o = document.createElement('option');
        o.value = p; o.textContent = p;
        packSelect.appendChild(o);
    });
    form.appendChild(packSelect);

    const tokensLabel = document.createElement('label');
    tokensLabel.textContent = 'Tokens to Spend:';
    form.appendChild(tokensLabel);

    const tokenInput = document.createElement('input');
    tokenInput.type = 'number'; tokenInput.min = '1'; tokenInput.value = '25'; tokenInput.step = '25';
    Object.assign(tokenInput.style, {
        padding: '12px 15px', borderRadius: '12px', backgroundColor: '#1b1b2f',
        color: '#e0d9ff', border: '1px solid #7c56ff', width: '100%', textAlign: 'center'
    });
    form.appendChild(tokenInput);

    const packInfo = document.createElement('div');
    packInfo.style = 'color:#bb86fc;font-size:0.95em;margin-top:-10px;';
    form.appendChild(packInfo);

    tokenInput.oninput = () => {
        const spend = parseInt(tokenInput.value, 10) || 0;
        const pack = packSelect.value;
        const price = blacket.packs[pack].price;
        const max = blacket.user.tokens;
        const count = Math.floor(spend / price);
        const left = max - (count * price);
        packInfo.textContent = count <= 0 || spend > max
            ? 'âš ï¸ Not enough tokens!'
            : `ðŸ§® Youâ€™ll open ${count} pack(s) | ðŸ’° Left after: ${left} tokens`;
    };
    packSelect.onchange = () => tokenInput.oninput();

    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'Open Packs';
    Object.assign(confirmBtn.style, {
        padding: '14px 0', width: '100%', fontSize: '1.1em', fontWeight: '700', backgroundColor: '#7c56ff',
        border: 'none', borderRadius: '14px', cursor: 'pointer', boxShadow: '0 5px 18px rgba(124,86,255,0.6)'
    });
    confirmBtn.onmouseenter = () => confirmBtn.style.backgroundColor = '#936dff';
    confirmBtn.onmouseleave = () => confirmBtn.style.backgroundColor = '#7c56ff';
    confirmBtn.onclick = () => {
        const pack = packSelect.value;
        const spend = parseInt(tokenInput.value, 10);
        const price = blacket.packs[pack].price;
        const maxSpend = blacket.user.tokens;
        if (isNaN(spend) || spend < price) return alert(`âŒ You need at least ${price} tokens to open one ${pack}.`);
        if (spend > maxSpend) return alert(`âŒ You only have ${maxSpend} tokens.`);
        const count = Math.floor(spend / price);
        if (count === 0) return alert("âŒ Not enough tokens to open any pack.");
        modal.style.display = 'none';
        openPacksSequential(pack, count);
    };
    form.appendChild(confirmBtn);

    modal.appendChild(form);
    document.body.appendChild(modal);

    const openBtn = document.createElement('button');
    openBtn.textContent = 'ðŸŽ‰ Open Packs';
    Object.assign(openBtn.style, {
        position: 'fixed', top: '60px', right: '20px', padding: '12px 28px', fontSize: '1.15rem',
        fontWeight: '700', background: 'linear-gradient(45deg,#7c56ff,#b497ff)', color: '#fff',
        border: 'none', borderRadius: '30px', cursor: 'pointer', boxShadow: '0 6px 20px rgba(124,86,255,0.6)',
        zIndex: 2200, fontFamily: font
    });
    openBtn.onmouseenter = () => openBtn.style.background = 'linear-gradient(45deg,#936dff,#d0bcff)';
    openBtn.onmouseleave = () => openBtn.style.background = 'linear-gradient(45deg,#7c56ff,#b497ff)';
    openBtn.onclick = () => modal.style.display = 'block';
    document.body.appendChild(openBtn);
})();
